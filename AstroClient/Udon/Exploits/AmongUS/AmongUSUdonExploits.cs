namespace AstroClient.UdonExploits
{
    using AstroClient.Components;
    using AstroLibrary.Console;
    using AstroLibrary.Extensions;
    using AstroLibrary.Utility;
    using RubyButtonAPI;
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using UnityEngine;
    using VRC.Udon;
    using VRC.Udon.Common.Interfaces;
    using static AstroClient.Variables.CustomLists;

    public class AmongUSUdonExploits : GameEvents
    {
        private static List<UdonBehaviour_Cached> CachedDoorsEvents = new List<UdonBehaviour_Cached>();

        public override void OnSceneLoaded(int buildIndex, string sceneName)
        {
            CachedDoorsEvents.Clear();
        }

        private static int RemoveSyncVotedForText(string key)
        {
            var removedtext = key.ToLower().Replace("syncvotedfor", string.Empty).Replace(" ", string.Empty);
            _ = int.TryParse(removedtext, out var value);
            return value;
        }

        public static void Init_GameController_Menu(QMNestedButton menu, float x, float y, bool btnHalf)
        {
            var main = new QMNestedButton(menu, x, y, "Game Controller", "Control The Game Events!", null, null, null, null, btnHalf);
            main.GetMainButton().SetResizeTextForBestFit(true);
            var registersub = new QMNestedButton(main, -5f, -5f, "", "");
            registersub.GetMainButton().SetActive(false);
            var MainScroll = new QMHalfScroll(registersub);
            var subscroll = new QMHalfScroll(main);
            _ = new QMSingleButton(main, 0, -1, "Refresh", delegate { MainScroll.Refresh(); subscroll.Refresh(); }, "", null, null, true);
            subscroll.SetAction(delegate
            {
                try
                {
                    foreach (var action in WorldUtils.GetUdonScripts())
                    {
                        if (action.gameObject.name == "Game Logic")
                        {
                            foreach (var subaction in action._eventTable)
                            {
                                var subaction_btn = new QMSingleButton(main, 0f, 0f, subaction.Key, null, action.gameObject?.ToString() + " Execute " + subaction.Key, null, null, true);
                                subaction_btn.SetAction(new Action(() => { action.SendCustomNetworkEvent(NetworkEventTarget.All, subaction.Key); }));
                                subscroll.Add(subaction_btn);
                            }
                            break;
                        }
                    }
                }
                catch (Exception e)
                {
                    ModConsole.Error($"[AMONG US]: Error in Game Controller Exploits Button!");
                    ModConsole.ErrorExc(e);
                    var btnerror = new QMSingleButton(main, 0f, 0f, "ERROR, SEE CONSOLE", null, "ERROR, SEE CONSOLE", null, Color.red, true);
                    subscroll.Add(btnerror);
                }
            }

            );
        }

        public static void Init_SabotageAndRepair_Menu(QMNestedButton menu, float x, float y, bool btnHalf)
        {
            var main = new QMNestedButton(menu, x, y, "Sabotage & Repair Exploits", "Run Udon Events globally", null, null, null, null, btnHalf);
            main.GetMainButton().SetResizeTextForBestFit(true);
            var registersub = new QMNestedButton(main, -5f, -5f, "", "");
            registersub.GetMainButton().SetActive(false);
            var MainScroll = new QMHalfScroll(registersub);
            var subscroll = new QMHalfScroll(main);
            _ = new QMSingleButton(main, 0, -1, "Refresh", delegate { MainScroll.Refresh(); subscroll.Refresh(); }, "", null, null, true);
            subscroll.SetAction(delegate
            {
                try
                {
                    foreach (var Behavior in WorldUtils.GetUdonScripts())
                    {
                        if (Behavior.gameObject.name == "Game Logic")
                        {
                            foreach (var subaction in Behavior._eventTable)
                            {
                                if (subaction.Key.StartsWith("SyncDoSabotage"))
                                {
                                    var cleanedstr = subaction.key.Replace("SyncDoSabotage", string.Empty).Replace(" ", string.Empty);

                                    var subaction_btn = new QMSingleButton(main, 0f, 0f, "Sabotage " + cleanedstr, null, Behavior.gameObject?.ToString() + " Sabotage " + cleanedstr, null, null, true);
                                    subaction_btn.SetTextColor(Color.red);
                                    subaction_btn.SetAction(new Action(() => { Behavior.SendCustomNetworkEvent(NetworkEventTarget.All, subaction.Key); }));
                                    subscroll.Add(subaction_btn);
                                    if (subaction.key.Contains("Doors"))
                                    {
                                        var tmp = new UdonBehaviour_Cached(Behavior, subaction.key);
                                        if (!CachedDoorsEvents.Contains(tmp))
                                        {
                                            CachedDoorsEvents.Add(tmp);
                                        }
                                    }
                                }
                                else if (subaction.Key.StartsWith("CancelAllSabotage"))
                                {
                                    var subaction_btn = new QMSingleButton(main, 0f, 0f, "Cancel All Sabotages ", null, Behavior.gameObject?.ToString() + "Cancel All Sabotages", null, null, true);
                                    subaction_btn.SetAction(new Action(() => { Behavior.SendCustomNetworkEvent(NetworkEventTarget.All, subaction.Key); }));
                                    subaction_btn.SetTextColor(Color.green);
                                    subscroll.Add(subaction_btn);
                                }
                                else if (subaction.Key.StartsWith("SyncRepair"))
                                {
                                    var cleanedstr = subaction.key.Replace("SyncRepair", string.Empty).Replace(" ", string.Empty);
                                    var subaction_btn = new QMSingleButton(main, 0f, 0f, "Repair " + cleanedstr, null, Behavior.gameObject?.ToString() + " Repair " + cleanedstr, null, null, true);
                                    subaction_btn.SetAction(new Action(() => { Behavior.SendCustomNetworkEvent(NetworkEventTarget.All, subaction.Key); }));
                                    subaction_btn.SetTextColor(Color.green);
                                    subscroll.Add(subaction_btn);
                                }
                            }
                            break;
                        }
                    }
                    if (CachedDoorsEvents.Count() != 0)
                    {
                        var subaction_btn = new QMSingleButton(main, 0f, 0f, "Sabotage All Doors", null, "Sabotage All Doors", null, null, true);
                        subaction_btn.SetAction(new Action(() =>
                        {
                            CachedDoorsEvents.ExecuteUdonEvent();
                        }));
                        subaction_btn.SetTextColor(Color.red);
                        subscroll.Add(subaction_btn);
                    }
                }
                catch (Exception e)
                {
                    ModConsole.Error($"[AMONG US]: Error in Sabotage & Repair Exploits Button!");
                    ModConsole.ErrorExc(e);
                    var btnerror = new QMSingleButton(main, 0f, 0f, "ERROR, SEE CONSOLE", null, "ERROR, SEE CONSOLE", null, Color.red, true);
                    subscroll.Add(btnerror);
                }
            }
            );
        }

        public static void Init_Unfiltered_Nodes_Menu(QMNestedButton menu, float x, float y, bool btnHalf)
        {
            var main = new QMNestedButton(menu, x, y, "Unfiltered Nodes", "Control Player Nodes events", null, null, null, null, btnHalf);
            var whytfisthishere = new QMNestedButton(main, -5f, -5f, "", "");
            whytfisthishere.GetMainButton().SetActive(false);
            var MainScroll = new QMHalfScroll(whytfisthishere);
            var subscroll = new QMHalfScroll(main);
            _ = new QMSingleButton(main, 0, -1, "Refresh", delegate
              {
                  MainScroll.Refresh();
                  subscroll.Refresh();
              }, "", null, null, true);
            subscroll.SetAction(delegate
            {
                try
                {
                    var filterstring = new List<string>();
                    if (JarRoleController.JarRoleLinks.Count() != 0)
                    {
                        foreach (var Component in JarRoleController.JarRoleLinks)
                        {
                            foreach (var action in Component.Node.GetComponentsInChildren<UdonBehaviour>())
                            {
                                if (action != null)
                                {
                                    string btnname = string.Empty;
                                    if (Component.NodeReader.VRCPlayerAPI != null && Component.NodeReader != null)
                                    {
                                        btnname = Component.NodeReader.VRCPlayerAPI.displayName;
                                    }
                                    else
                                    {
                                        btnname = action.gameObject.name;
                                    }

                                    if (filterstring.Contains(btnname))
                                    {
                                        continue;
                                    }
                                    else
                                    {
                                        subscroll.Add(new QMSingleButton(main, 0f, 0f, btnname, delegate
                                        {
                                            MainScroll.SetAction(delegate
                                            {
                                                foreach (var subaction in action._eventTable)
                                                {
                                                    var subaction_btn = new QMSingleButton(MainScroll.BaseMenu, 0f, 0f, subaction.Key, delegate
                                                    {
                                                        action.SendCustomNetworkEvent(NetworkEventTarget.All, subaction.Key);
                                                    }, action.gameObject?.ToString() + " Run " + subaction.Key, null, null, true);
                                                    MainScroll.Add(subaction_btn);
                                                }
                                            });
                                            MainScroll.BaseMenu.GetMainButton().GetGameObject().GetComponent<UnityEngine.UI.Button>()
                                                .onClick.Invoke();
                                        }, action.interactText, null, null, true));
                                        filterstring.Add(btnname);
                                    }
                                }
                            }
                        }
                    }
                    else
                    {
                        var NoNodesFound = new QMSingleButton(main, 0f, 0f, "No Nodes Found", null, "No Nodes Found", null, null, true);
                        subscroll.Add(NoNodesFound);
                    }
                }
                catch (Exception e)
                {
                    ModConsole.Error($"[Among US]: Error in Unfiltered Nodes Button!");
                    ModConsole.ErrorExc(e);
                    var btnerror = new QMSingleButton(main, 0f, 0f, "ERROR, SEE CONSOLE", null, "ERROR, SEE CONSOLE", null, Color.red, true);
                    subscroll.Add(btnerror);
                }
            });
        }

        public static void Init_FilteredNodes_Menu(QMNestedButton menu, float x, float y, bool btnHalf)
        {
            var main = new QMNestedButton(menu, x, y, "Filtered Nodes", "Run Udon Events globally", null, null, null, null, btnHalf);
            main.GetMainButton().SetResizeTextForBestFit(true);
            var idkwhythisishere = new QMNestedButton(main, -5f, -5f, "", "");
            idkwhythisishere.GetMainButton().SetActive(false);
            var MainScroll = new QMHalfScroll(idkwhythisishere);
            var subscroll = new QMHalfScroll(main);
            _ = new QMSingleButton(main, 0, -1, "Refresh", delegate
              {
                  MainScroll.Refresh();
                  subscroll.Refresh();
              }, "", null, null, true);
            subscroll.SetAction(delegate
            {
                try
                {
                    if (JarRoleController.RoleEspComponents.Count() != 0)
                    {
                        var tmplist = new List<string>();
                        foreach (var Component in JarRoleController.RoleEspComponents)
                        {
                            if (Component != null && Component.LinkedNode != null)
                            {
                                foreach (var action in Component.LinkedNode.Node.GetComponentsInChildren<UdonBehaviour>())
                                {
                                    if (action != null)
                                    {
                                        if (Component.LinkedNode.NodeReader.VRCPlayerAPI != null)
                                        {

                                            var NodeTranslated = Component.LinkedNode.NodeReader.VRCPlayerAPI.displayName;
                                            if (tmplist.Contains(NodeTranslated))
                                            {
                                                continue;
                                            }
                                            else
                                            {
                                                var PlayerExploitsChoicesBtn = new QMSingleButton(main, 0f, 0f, NodeTranslated, delegate
                                        {
                                            MainScroll.SetAction(delegate
                                            {
                                                foreach (var subaction in action._eventTable)
                                                {
                                                    var anothertmplist = new List<string>();
                                                // RENAME SyncVotedFor With Node Name.
                                                if (subaction.Key.ToLower().StartsWith("syncvotedfor"))
                                                    {
                                                        var LinkedComponent = JarRoleController.GetLinkedComponent(RemoveSyncVotedForText(subaction.key));
                                                        if (LinkedComponent != null && LinkedComponent.LinkedNode != null)
                                                    {
                                                            if (LinkedComponent.LinkedNode.NodeReader.VRCPlayerAPI != null)
                                                            {

                                                                var LinkedNodeTranslated = LinkedComponent.LinkedNode.NodeReader.VRCPlayerAPI.displayName;

                                                                if (anothertmplist.Contains(LinkedNodeTranslated))
                                                                {
                                                                    continue;
                                                                }
                                                                else
                                                                {
                                                                    var SyncVotedForBtn = new QMSingleButton(MainScroll.BaseMenu, 0f, 0f, "Vote: " + LinkedNodeTranslated, delegate { action.SendCustomNetworkEvent(NetworkEventTarget.All, subaction.Key); }, action.gameObject?.ToString() + " Run " + "Vote: " + LinkedNodeTranslated, null, null, true);
                                                                    if (LinkedComponent.AmongUsGetNamePlateColor() != null)
                                                                    {
                                                                        SyncVotedForBtn.SetTextColor(LinkedComponent.AmongUsGetNamePlateColor().Value);
                                                                    }
                                                                    SyncVotedForBtn.SetResizeTextForBestFit(true);
                                                                    MainScroll.Add(SyncVotedForBtn);
                                                                    anothertmplist.Add(LinkedNodeTranslated);
                                                                }
                                                            }
                                                        }
                                                    }
                                                    else
                                                    {
                                                        var tmp_action_1 = new QMSingleButton(MainScroll.BaseMenu, 0f, 0f, subaction.Key, delegate { action.SendCustomNetworkEvent(NetworkEventTarget.All, subaction.Key); }, action.gameObject?.ToString() + " Run " + subaction.Key, null, null, true);
                                                        MainScroll.Add(tmp_action_1);
                                                    }
                                                }
                                            });
                                            MainScroll.BaseMenu.GetMainButton().GetGameObject().GetComponent<UnityEngine.UI.Button>()
                                                .onClick.Invoke();
                                        }, action.interactText, null, null, true);
                                                var textcolor = Component.AmongUsGetNamePlateColor();
                                                if (textcolor != null)
                                                {
                                                    PlayerExploitsChoicesBtn.SetTextColor(textcolor.Value);
                                                }
                                                subscroll.Add(PlayerExploitsChoicesBtn);
                                                tmplist.Add(NodeTranslated);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    else
                    {
                        var NoNodesFound = new QMSingleButton(main, 0f, 0f, "No Nodes Found", null, "No Nodes Found", null, null, true);
                        subscroll.Add(NoNodesFound);
                    }
                }
                catch (Exception e)
                {
                    ModConsole.Error($"[AMONG US]: Error in Filtered Nodes Button!");
                    ModConsole.ErrorExc(e);
                    var btnerror = new QMSingleButton(main, 0f, 0f, "ERROR, SEE CONSOLE", null, "ERROR, SEE CONSOLE", null, Color.red, true);
                    subscroll.Add(btnerror);
                }
            }
            );
        }

        // TODO : Make a mechanism to prevent people who already voted so it doesn't make duplicate votes on instances lol

        public static void Init_ForceVotePlayer_menu(QMNestedButton menu, float x, float y, bool btnHalf)
        {
            var main = new QMNestedButton(menu, x, y, "Force Vote", "Run Udon Events globally", null, null, null, null, btnHalf);
            main.GetMainButton().SetResizeTextForBestFit(true);
            var idkwhythisishere = new QMNestedButton(main, -5f, -5f, "", "");
            idkwhythisishere.GetMainButton().SetActive(false);
            var MainScroll = new QMHalfScroll(idkwhythisishere);
            var subscroll = new QMHalfScroll(main);
            _ = new QMSingleButton(main, 0, -1, "Refresh", delegate
              {
                  MainScroll.Refresh();
                  subscroll.Refresh();
              }, "", null, null, true);
            _ = new QMSingleButton(main, 0, 0, "All Skip voting", delegate
              {
                  AllSkipVote();
              }, "", null, Color.green, true);
            subscroll.SetAction(delegate
            {
                try
                {
                    if (JarRoleController.RoleEspComponents.Count() != 0)
                    {
                        var tmplist = new List<string>();
                        foreach (var Component in JarRoleController.RoleEspComponents)
                        {
                            if (Component != null && Component.LinkedNode != null)
                            {
                                foreach (var action in Component.LinkedNode.Node.GetComponentsInChildren<UdonBehaviour>())
                                {
                                    if (action != null)
                                    {
                                        if (Component.LinkedNode.NodeReader.VRCPlayerAPI != null)
                                        {

                                            var NodeTranslated = Component.LinkedNode.NodeReader.VRCPlayerAPI.displayName;
                                            if (tmplist.Contains(NodeTranslated))
                                            {
                                                continue;
                                            }
                                            else
                                            {
                                                var PlayerExploitsChoicesBtn = new QMSingleButton(main, 0f, 0f, NodeTranslated, delegate
                                        {
                                            MainScroll.SetAction(delegate
                                            {
                                                bool HasAddedEveryoneVoteBtn = false;
                                                foreach (var subaction in action._eventTable)
                                                {
                                                    var anothertmplist = new List<string>();
                                                // RENAME SyncVotedFor With Node Name.
                                                if (subaction.Key.ToLower().StartsWith("syncvotedfor"))
                                                    {
                                                        var LinkedComponent = JarRoleController.GetLinkedComponent(RemoveSyncVotedForText(subaction.key));
                                                        if (LinkedComponent != null)
                                                        {
                                                            if (LinkedComponent.LinkedNode != null)
                                                            {
                                                                if (LinkedComponent.LinkedNode.NodeReader.VRCPlayerAPI != null)
                                                                {

                                                                    var btnactionname = "Vote: " + LinkedComponent.LinkedNode.NodeReader.VRCPlayerAPI.displayName;
                                                                    if (anothertmplist.Contains(btnactionname))
                                                                    {
                                                                        continue;
                                                                    }
                                                                    else
                                                                    {
                                                                        var SyncVotedForBtn = new QMSingleButton(MainScroll.BaseMenu, 0f, 0f, btnactionname, delegate { if (!Component.AmongUSHasVoted) { action.SendCustomNetworkEvent(NetworkEventTarget.All, subaction.Key); } }, action.gameObject?.ToString() + " Run " + btnactionname, null, null, true);
                                                                        if (LinkedComponent.AmongUsGetNamePlateColor() != null)
                                                                        {
                                                                            SyncVotedForBtn.SetTextColor(LinkedComponent.AmongUsGetNamePlateColor().Value);
                                                                        }
                                                                        SyncVotedForBtn.SetResizeTextForBestFit(true);
                                                                        if (!anothertmplist.Contains(btnactionname))
                                                                        {
                                                                            MainScroll.Add(SyncVotedForBtn);
                                                                            anothertmplist.Add(btnactionname);
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                    if (!HasAddedEveryoneVoteBtn)
                                                    {
                                                        var AllVote = new QMSingleButton(MainScroll.BaseMenu, 0f, 0f, "Everyone vote : " + NodeTranslated, delegate { AllVoteFor(Component); }, action.gameObject?.ToString() + "Everyone votes : " + NodeTranslated, null, Color.green, true);
                                                        AllVote.SetResizeTextForBestFit(true);
                                                        MainScroll.Add(AllVote);
                                                        HasAddedEveryoneVoteBtn = true;
                                                    }
                                                    if (subaction.Key.ToLower().StartsWith("syncabstainedvoting"))
                                                    {
                                                        var SkipVoting = new QMSingleButton(MainScroll.BaseMenu, 0f, 0f, "Skip Voting", delegate
                                                        {
                                                            if (Component.AmongUSCanVote)
                                                            {
                                                                action.SendCustomNetworkEvent(NetworkEventTarget.All, subaction.Key);
                                                            }
                                                        }, action.gameObject?.ToString() + " Run " + "Skip Voting", null, Color.green, true);
                                                        MainScroll.Add(SkipVoting);
                                                    }
                                                }
                                            });
                                            MainScroll.BaseMenu.GetMainButton().GetGameObject().GetComponent<UnityEngine.UI.Button>()
                                                .onClick.Invoke();
                                        }, action.interactText, null, null, true);
                                                var textcolor = Component.AmongUsGetNamePlateColor();
                                                if (textcolor != null)
                                                {
                                                    PlayerExploitsChoicesBtn.SetTextColor(textcolor.Value);
                                                }
                                                subscroll.Add(PlayerExploitsChoicesBtn);
                                                tmplist.Add(NodeTranslated);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    else
                    {
                        var NoNodesFound = new QMSingleButton(main, 0f, 0f, "No Nodes Found", null, "No Nodes Found", null, null, true);
                        subscroll.Add(NoNodesFound);
                    }
                }
                catch (Exception e)
                {
                    ModConsole.Error($"[AMONG US]: Error in Force Vote Button!");
                    ModConsole.ErrorExc(e);
                    var btnerror = new QMSingleButton(main, 0f, 0f, "ERROR, SEE CONSOLE", null, "ERROR, SEE CONSOLE", null, Color.red, true);
                    subscroll.Add(btnerror);
                }
            });
        }

        private static void AllSkipVote()
        {
            if (JarRoleController.RoleEspComponents.Count() != 0)
            {
                foreach (var ActiveNode in JarRoleController.RoleEspComponents)
                {
                    if (ActiveNode != null && ActiveNode.LinkedNode != null && ActiveNode.AmongUsCurrentRole != JarRoleESP.AmongUsRoles.None && ActiveNode.AmongUsCurrentRole != JarRoleESP.AmongUsRoles.Unassigned)
                    {
                        bool HasVoted = false;
                        foreach (var action in ActiveNode.LinkedNode.Node.GetComponentsInChildren<UdonBehaviour>())
                        {
                            foreach (var subaction in action._eventTable)
                            {
                                if (subaction.Key.ToLower().StartsWith("syncabstainedvoting"))
                                {
                                    if (ActiveNode.AmongUSCanVote)
                                    {
                                        action.SendCustomNetworkEvent(NetworkEventTarget.All, subaction.Key);
                                    }
                                    HasVoted = true;
                                    break;
                                }
                            }
                            if (HasVoted)
                            {
                                break;
                            }
                        }
                    }
                }
            }
        }

        // TODO : ENCHANCE OR OPTIMIZE.
        private static void AllVoteFor(JarRoleESP VictimComponent)
        {
            if (VictimComponent != null && VictimComponent.Player != null && VictimComponent.LinkedNode != null)
            {
                if (JarRoleController.RoleEspComponents.Count() != 0)
                {
                    foreach (var ActiveNode in JarRoleController.RoleEspComponents)
                    {
                        if (ActiveNode != null && VictimComponent.LinkedNode.Node != null && ActiveNode.AmongUsCurrentRole != JarRoleESP.AmongUsRoles.None && ActiveNode.AmongUsCurrentRole != JarRoleESP.AmongUsRoles.Unassigned && ActiveNode != VictimComponent.LinkedNode.Node)
                        {
                            bool HasVoted = false;
                            foreach (var action in ActiveNode.LinkedNode.Node.GetComponentsInChildren<UdonBehaviour>())
                            {
                                foreach (var subaction in action._eventTable)
                                {
                                    if (subaction.Key.ToLower().StartsWith("syncvotedfor"))
                                    {
                                        var ExtractedNode = JarRoleController.GetLinkedComponent(RemoveSyncVotedForText(subaction.key));
                                        if (ExtractedNode != null && ExtractedNode.LinkedNode.Node != null && ExtractedNode.AmongUsCurrentRole != JarRoleESP.AmongUsRoles.None && ExtractedNode.AmongUsCurrentRole != JarRoleESP.AmongUsRoles.Unassigned)
                                        {
                                            if (ExtractedNode.Player.DisplayName() == VictimComponent.Player.DisplayName())
                                            {
                                                //ModConsole.DebugLog($"Executing Udon Event {action.name} with subaction {subaction.key} That Contains Player : {ExtractedNode.apiuser.displayName}");
                                                if (ActiveNode.AmongUSCanVote)
                                                {
                                                    action.SendCustomNetworkEvent(NetworkEventTarget.All, subaction.Key);
                                                }
                                                HasVoted = true;
                                                break;
                                            }
                                        }
                                    }
                                }
                                if (HasVoted)
                                {
                                    break;
                                }
                            }
                        }
                    }
                }
            }
        }

        public static void Init_RoleSwap_Menu(QMNestedButton menu, float x, float y, bool btnHalf)
        {
            var main = new QMNestedButton(menu, x, y, "Swap Roles", "Run Udon Events globally", null, null, null, null, btnHalf);
            main.GetMainButton().SetResizeTextForBestFit(true);
            var idkwhythisishere = new QMNestedButton(main, -5f, -5f, "", "");
            idkwhythisishere.GetMainButton().SetActive(false);
            var MainScroll = new QMHalfScroll(idkwhythisishere);
            var subscroll = new QMHalfScroll(main);
            _ = new QMSingleButton(main, 0, -1, "Refresh", delegate
              {
                  MainScroll.Refresh();
                  subscroll.Refresh();
              }, "", null, null, true);
            subscroll.SetAction(delegate
            {
                try
                {
                    if (JarRoleController.RoleEspComponents.Count() != 0)
                    {
                        var tmplist = new List<string>();
                        foreach (var Component in JarRoleController.RoleEspComponents)
                        {
                            if (Component != null && Component.LinkedNode != null)
                            {
                                foreach (var action in Component.LinkedNode.Node.GetComponentsInChildren<UdonBehaviour>())
                                {
                                    if (action != null)
                                    {
                                        if (Component.LinkedNode.NodeReader.VRCPlayerAPI != null)
                                        {

                                            string NodeName = Component.LinkedNode.NodeReader.VRCPlayerAPI.displayName;
                                            if (tmplist.Contains(NodeName))
                                            {
                                                continue;
                                            }
                                            else
                                            {
                                                var playerbtn = new QMSingleButton(main, 0f, 0f, NodeName, null, "Swap Role with " + NodeName, null, null, true);
                                                playerbtn.SetAction(new Action(() =>
                                                {
                                                // FIND ASSIGNED ROLE ON PLAYER NODE
                                                string SelfRoleString = "none";
                                                    string TargetRoleString = "none";

                                                    var LocalPlayer = JarRoleController.CurrentPlayerRoleESP;
                                                    if (LocalPlayer != null)
                                                    {
                                                        if (LocalPlayer.AmongUsCurrentRole == JarRoleESP.AmongUsRoles.Crewmate)
                                                        {
                                                            SelfRoleString = "SyncAssignB";
                                                        }
                                                        if (LocalPlayer.AmongUsCurrentRole == JarRoleESP.AmongUsRoles.Impostor)
                                                        {
                                                            SelfRoleString = "SyncAssignM";
                                                        }
                                                    }
                                                    if (Component != null)
                                                    {
                                                        if (Component.AmongUsCurrentRole == JarRoleESP.AmongUsRoles.Crewmate)
                                                        {
                                                            TargetRoleString = "SyncAssignB";
                                                        }
                                                        if (Component.AmongUsCurrentRole == JarRoleESP.AmongUsRoles.Impostor)
                                                        {
                                                            TargetRoleString = "SyncAssignM";
                                                        }
                                                    }

                                                    UdonSearch.FindUdonEvent(LocalPlayer.LinkedNode.Node.gameObject, TargetRoleString).ExecuteUdonEvent();
                                                    UdonSearch.FindUdonEvent(Component.LinkedNode.Node.gameObject, SelfRoleString).ExecuteUdonEvent();
                                                }));

                                                var textcolor = Component.AmongUsGetNamePlateColor();
                                                if (textcolor != null)
                                                {
                                                    playerbtn.SetTextColor(textcolor.Value);
                                                }
                                                subscroll.Add(playerbtn);
                                                tmplist.Add(NodeName);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    else
                    {
                        var NoNodesFound = new QMSingleButton(main, 0f, 0f, "No Nodes Found", null, "No Nodes Found", null, null, true);
                        subscroll.Add(NoNodesFound);
                    }
                }
                catch (Exception e)
                {
                    ModConsole.Error($"[MURDER 4]: Error in Role Swapper Button!");
                    ModConsole.ErrorExc(e);
                    var btnerror = new QMSingleButton(main, 0f, 0f, "ERROR, SEE CONSOLE", null, "ERROR, SEE CONSOLE", null, Color.red, true);
                    subscroll.Add(btnerror);
                }
            });
        }

        public static void Init_ForcePlayerEject_Menu(QMNestedButton menu, float x, float y, bool btnHalf)
        {
            var main = new QMNestedButton(menu, x, y, "Eject Players", "Run Udon Events globally", null, null, null, null, btnHalf);
            main.GetMainButton().SetResizeTextForBestFit(true);
            var idkwhythisishere = new QMNestedButton(main, -5f, -5f, "", "");
            idkwhythisishere.GetMainButton().SetActive(false);
            var MainScroll = new QMHalfScroll(idkwhythisishere);
            var subscroll = new QMHalfScroll(main);
            _ = new QMSingleButton(main, 0, -1, "Refresh", delegate
              {
                  MainScroll.Refresh();
                  subscroll.Refresh();
              }, "", null, null, true);
            subscroll.SetAction(delegate
            {
                try
                {
                    if (JarRoleController.RoleEspComponents.Count() != 0)
                    {
                        var tmplist = new List<string>();
                        foreach (var Component in JarRoleController.RoleEspComponents)
                        {
                            if (Component != null && Component.LinkedNode != null)
                            {
                                foreach (var action in Component.LinkedNode.Node.GetComponentsInChildren<UdonBehaviour>())
                                {
                                    if (action != null)
                                    {
                                        if (Component.LinkedNode.NodeReader.VRCPlayerAPI != null)
                                        {

                                            string NodeName = Component.LinkedNode.NodeReader.VRCPlayerAPI.displayName;

                                            if (tmplist.Contains(NodeName))
                                            {
                                                continue;
                                            }
                                            else
                                            {
                                                var KillPlayerBtn = new QMSingleButton(main, 0f, 0f, "Eject " + NodeName, null, "Eject " + NodeName, null, null, true);
                                                // FIND THE KILL ACTION
                                                foreach (var subaction in action._eventTable)
                                                {
                                                    if (subaction.key == "SyncVotedOut")
                                                    {
                                                        KillPlayerBtn.SetAction(new Action(() =>
                                                        {
                                                            action.SendCustomNetworkEvent(NetworkEventTarget.All, subaction.Key);
                                                        }));
                                                        break;
                                                    }
                                                }

                                                var textcolor = Component.AmongUsGetNamePlateColor();
                                                if (textcolor != null)
                                                {
                                                    KillPlayerBtn.SetTextColor(textcolor.Value);
                                                }
                                                subscroll.Add(KillPlayerBtn);
                                                tmplist.Add(NodeName);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    else
                    {
                        var NoNodesFound = new QMSingleButton(main, 0f, 0f, "No Nodes Found", null, "No Nodes Found", null, null, true);
                        subscroll.Add(NoNodesFound);
                    }
                }
                catch (Exception e)
                {
                    ModConsole.Error($"[AMONG US]: Error in Eject Players Button!");
                    ModConsole.ErrorExc(e);
                    var btnerror = new QMSingleButton(main, 0f, 0f, "ERROR, SEE CONSOLE", null, "ERROR, SEE CONSOLE", null, Color.red, true);
                    subscroll.Add(btnerror);
                }
            });
        }

        public static void Init_KillPlayers_Menu(QMNestedButton menu, float x, float y, bool btnHalf)
        {
            var main = new QMNestedButton(menu, x, y, "Kill Players", "Run Udon Events globally", null, null, null, null, btnHalf);
            main.GetMainButton().SetResizeTextForBestFit(true);
            var idkwhythisishere = new QMNestedButton(main, -5f, -5f, "", "");
            idkwhythisishere.GetMainButton().SetActive(false);
            var MainScroll = new QMHalfScroll(idkwhythisishere);
            var subscroll = new QMHalfScroll(main);
            _ = new QMSingleButton(main, 0, -1, "Refresh", delegate
              {
                  MainScroll.Refresh();
                  subscroll.Refresh();
              }, "", null, null, true);
            subscroll.SetAction(delegate
            {
                try
                {
                    if (JarRoleController.RoleEspComponents.Count() != 0)
                    {
                        var tmplist = new List<string>();
                        foreach (var Component in JarRoleController.RoleEspComponents)
                        {
                            if (Component != null && Component.LinkedNode != null)
                            {
                                foreach (var action in Component.LinkedNode.Node.GetComponentsInChildren<UdonBehaviour>())
                                {
                                    if (action != null)
                                    {
                                        if (Component.LinkedNode.NodeReader.VRCPlayerAPI != null)
                                        {
                                            string NodeName = Component.LinkedNode.NodeReader.VRCPlayerAPI.displayName;

                                            if (tmplist.Contains(NodeName))
                                            {
                                                continue;
                                            }
                                            else
                                            {
                                                var KillPlayerBtn = new QMSingleButton(main, 0f, 0f, "Kill " + NodeName, null, "Kill " + NodeName, null, null, true);
                                                // FIND THE KILL ACTION
                                                foreach (var subaction in action._eventTable)
                                                {
                                                    if (subaction.key == "SyncKill")
                                                    {
                                                        KillPlayerBtn.SetAction(new Action(() =>
                                                        {
                                                            action.SendCustomNetworkEvent(NetworkEventTarget.All, subaction.Key);
                                                        }));
                                                        break;
                                                    }
                                                }

                                                var textcolor = Component.AmongUsGetNamePlateColor();
                                                if (textcolor != null)
                                                {
                                                    KillPlayerBtn.SetTextColor(textcolor.Value);
                                                }
                                                subscroll.Add(KillPlayerBtn);
                                                tmplist.Add(NodeName);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    else
                    {
                        var NoNodesFound = new QMSingleButton(main, 0f, 0f, "No Nodes Found", null, "No Nodes Found", null, null, true);
                        subscroll.Add(NoNodesFound);
                    }
                }
                catch (Exception e)
                {
                    ModConsole.Error($"[AMONG US]: Error in Kill Players Button!");
                    ModConsole.ErrorExc(e);
                    var btnerror = new QMSingleButton(main, 0f, 0f, "ERROR, SEE CONSOLE", null, "ERROR, SEE CONSOLE", null, Color.red, true);
                    subscroll.Add(btnerror);
                }
            });
        }
    }
}