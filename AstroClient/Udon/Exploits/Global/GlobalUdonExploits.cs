using RubyButtonAPI;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using VRC.Udon;
using VRC.Udon.Common.Interfaces;
using UnityEngine;
using System.Collections;
using MelonLoader;
using AstroClient.ConsoleUtils;

namespace AstroClient.UdonExploits
{
    public static class GlobalUdonExploits
    {

        public static void InitButtons(QMNestedButton menu, float x, float y, bool btnHalf)
        {

            var Menu = new QMNestedButton(menu, x, y, "Udon Exploits", "Run Udon Events globally", null, null, null, null, btnHalf);
            var whytfisthishere = new QMNestedButton(Menu, -5f, -5f, "", "");
            whytfisthishere.getMainButton().setActive(false);
            var MainScroll = new QMScrollMenu(whytfisthishere);
            var subscroll = new QMScrollMenu(Menu);
            new QMSingleButton(Menu, 0, -1, "Refresh", delegate
            {
                MainScroll.Refresh();
                subscroll.Refresh();
            }, "", null, null, true);
            new QMSingleButton(Menu, 0, 0, "Break Udon Instance", delegate
            {
                MelonCoroutines.Start(RunAllUdonActions());

            }, "Breaks all the events by running all udon events!, But Dont be a fucking toxic asshole who kills udons for fun.", null, Color.red, true);

            subscroll.SetAction(delegate
            {
                foreach (var action in UnityEngine.Object.FindObjectsOfType<UdonBehaviour>())
                {
                    subscroll.Add(new QMSingleButton(Menu, 0f, 0f, action.gameObject.name, delegate
                    {
                        MainScroll.SetAction(delegate
                        {
                            foreach (var subaction in action._eventTable)
                            {
                                MainScroll.Add(new QMSingleButton(MainScroll.BaseMenu, 0f, 0f, subaction.Key, delegate
                                {
                                    action.SendCustomNetworkEvent(NetworkEventTarget.All, subaction.Key);
                                }, (action.gameObject)?.ToString() + " Run " + subaction.Key));
                            }
                        });
                        MainScroll.BaseMenu.getMainButton().getGameObject().GetComponent<UnityEngine.UI.Button>()
                            .onClick.Invoke();
                    }, action.interactText));
                }
            });
        }

        public static IEnumerator RunAllUdonActions()
        {
            var udonevents = UnityEngine.Object.FindObjectsOfType<UdonBehaviour>();
            if(udonevents == null) { yield return null; }
            if(udonevents.Count() == 0) { yield return null; }
            foreach (var action in udonevents )
            {
                foreach(var subaction in action._eventTable)
                {
                    action.SendCustomNetworkEvent(NetworkEventTarget.All, subaction.Key);
                }
            }
            yield return null;
        }

    }
}
